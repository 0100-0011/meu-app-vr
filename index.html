<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automação de VR</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 2rem;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .progress-bar {
            height: 28px;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 0.75rem;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.4s ease-in-out;
            border-radius: 0.5rem;
        }

        #step-progress-fill {
            background-color: #6366f1; /* Indigo */
        }

        #overall-progress-fill {
            background-color: #10b981; /* Green */
        }

        #log-area {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            min-height: 150px;
            max-height: 300px;
            text-align: left;
            margin-top: 1.5rem;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .step-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .step-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .step-label {
            font-weight: 600;
            color: #4b5563;
            min-width: 180px;
            text-align: left;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1rem;
            color: white;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-run {
            background-color: #4f46e5;
        }
        .btn-run:hover:not(:disabled) { background-color: #4338ca; transform: translateY(-1px); }
        .btn-run:disabled { background-color: #a5b4fc; cursor: not-allowed; }

        .btn-download {
            background-color: #10b981;
        }
        .btn-download:hover:not(:disabled) { background-color: #059669; transform: translateY(-1px); }
        .btn-download:disabled { background-color: #6ee7b7; cursor: not-allowed; }

        .preview-section {
            display: none;
            margin-top: 2rem;
            text-align: left;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            max-height: 400px;
            overflow-y: auto;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .preview-table th, .preview-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }

        .preview-table th {
            background-color: #e5e7eb;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center p-4 min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-bold mb-4 text-gray-800">Automação de Vale-Refeição</h1>
        <p class="text-gray-600 mb-6">Esta aplicação simula o processo de cálculo de vale-refeição em várias etapas, utilizando dados de diferentes fontes. Clique em "Iniciar Processo" para começar. Após a conclusão de cada etapa, você poderá visualizar o resultado e baixar os relatórios intermediários e o resultado final.</p>

        <!-- Seção de Progresso da Etapa Atual -->
        <h2 class="text-xl font-semibold text-gray-700">Progresso da Etapa: <span id="current-step-name">Aguardando...</span></h2>
        <div class="progress-bar">
            <div id="step-progress-fill" class="progress-fill"></div>
        </div>
        <p class="text-sm text-gray-500"><span id="step-progress-text">0%</span></p>

        <!-- Seção de Progresso Total -->
        <h2 class="text-xl font-semibold text-gray-700 mt-6">Progresso Total</h2>
        <div class="progress-bar">
            <div id="overall-progress-fill" class="progress-fill"></div>
        </div>
        <p class="text-sm text-gray-500"><span id="overall-progress-text">0%</span></p>

        <!-- Botões de Ação por Etapa -->
        <div id="step-buttons" class="step-container">
            <!-- Botões serão gerados aqui dinamicamente -->
        </div>

        <!-- Área de Log -->
        <div id="log-area" class="mt-4">
            <p class="text-gray-600">Clique em "Iniciar Processo" para começar.</p>
        </div>

        <!-- Área para Exibir o Preview -->
        <div id="preview-section" class="preview-section">
            <h3 id="preview-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <div id="preview-content"></div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // Dados completos fornecidos nos arquivos CSV.
        // Acesso a esses dados é simulado, como se estivessem sendo lidos localmente.
        const dados_completos = {
            'ativos': `MATRICULA,EMPRESA,TITULO DO CARGO,DESC. SITUACAO,Sindicato
34941,1410,TECH RECRUITER II,Trabalhando,SINDPD SP - SIND.TRAB.EM PROC DADOS E EMPR.EMPRESAS PROC DADOS ESTADO DE SP.
24401,1410,COORDENADOR ADMINISTRATIVO,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
32104,1410,ANALISTA CONTABIL-FISCAL II,Férias,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
35254,1410,ANALISTA CONTABIL-FISCAL II,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
31731,1410,ANALISTA CONTABIL-FISCAL III,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
31009,1410,ANALISTA DE CONTROLADORIA I,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
28979,1410,ANALISTA DE CONTROLADORIA II,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
24122,1410,SINDICALISTA,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
30556,1410,DESENVOLVEDOR II,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
35627,1410,ASSISTENTE DE BPO I,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
34789,1410,ASSISTENTE DE BPO I,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
24505,1410,DESENVOLVEDOR III,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
27071,1410,DESENVOLVEDOR III,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
24475,1410,ANALISTA DE SISTEMAS E NEGOCIOS II,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
26273,1410,ANALISTA DE SISTEMAS E NEGOCIOS II,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
32050,1410,COORDENADOR DE OPERACOES III,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
34543,1410,DIRETOR,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL`,
            'admissoes': `MATRICULA,Admissão,Cargo
35741,2025-04-07,COORDENADOR DE OPERACOES III
35774,2025-04-22,ANALISTA DADOS I
35722,2025-04-02,ASSISTENTE DE BPO I
35767,2025-04-22,DESENVOLVEDOR III
35701,2025-04-01,GERENTE DE SERVICOS SENIOR
35770,2025-04-23,ASSISTENTE DE BPO I
35714,2025-04-01,ANALISTA DADOS III
35727,2025-04-02,ENGENHEIRO DADOS II
35743,2025-04-08,ASSISTENTE DE BPO I
35782,2025-04-28,DESENVOLVEDOR III
35726,2025-04-02,ASSISTENTE DE BPO I
35769,2025-04-23,ASSISTENTE DE BPO I
35752,2025-04-14,ASSISTENTE DE BPO I
35738,2025-04-07,DESENVOLVEDOR II
35740,2025-04-08,DESENVOLVEDOR III
35705,2025-04-07,CONS. FUNCIONAL SAP III
35754,2025-04-14,DESENVOLVEDOR III
35742,2025-04-08,SDR II
35772,2025-04-22,ASSISTENTE DE BPO I
35721,2025-04-01,ASSISTENTE DE BPO I
35759,2025-04-16,ASSISTENTE DE BPO I
35760,2025-04-15,ASSISTENTE DE BPO I
35723,2025-04-02,ASSISTENTE DE BPO I
35707,2025-04-01,AGILE MASTER
35749,2025-04-10,DESENVOLVEDOR III
35713,2025-04-02,ASSISTENTE DE BPO I
35753,2025-04-16,COORDENADOR DE OPERACOES III
35717,2025-04-01,DESENVOLVEDOR III
35716,2025-04-01,ESTAGIARIO
35768,2025-04-22,CONS. ESP`,
            'ferias': `MATRICULA,DESC. SITUACAO,DIAS DE FÉRIAS
32104,Férias,10
32761,Férias,10
30567,Férias,10
30502,Férias,15
33998,Férias,20
30867,Férias,10
31237,Férias,15
32278,Férias,20
33808,Férias,5
26910,Férias,30
30206,Férias,30
32216,Férias,30
30570,Férias,30
32589,Férias,30
31740,Férias,30
33235,Férias,30
34042,Férias,30
33420,Férias,5
31190,Férias,5
31208,Férias,5
33715,Férias,5
30280,Férias,5
34444,Férias,5
29058,Férias,15
33628,Férias,20
33795,Férias,15
33633,Férias,20
26463,Férias,10
31333,Férias,15`,
            'aprendizes': `MATRICULA,TITULO DO CARGO
34383,APRENDIZ
34404,APRENDIZ
35086,APRENDIZ
34396,APRENDIZ
34403,APRENDIZ
35640,APRENDIZ
34951,APRENDIZ TECH
34950,APRENDIZ TI
35088,APRENDIZ
35635,APRENDIZ
35081,APRENDIZ
35641,APRENDIZ
35637,APRENDIZ
35639,APRENDIZ
35642,APRENDIZ
35636,APRENDIZ
35607,APRENDIZ AUX  ADMINISTRATIVO
35366,APRENDIZ
35643,APRENDIZ
34392,APRENDIZ
35085,APRENDIZ
34398,APRENDIZ
35089,APRENDIZ
35644,APRENDIZ
34394,APRENDIZ
34953,APRENDIZ TECH
35058,APRENDIZ
35638,APRENDIZ
34952,APRENDIZ
35571,APRENDIZ
35609,APRENDIZ AUX  ADMINISTRATIVO
35610,APRENDIZ AUX  ADMINISTRATIVO
35608,APRENDIZ AUX  ADMINISTRATIVO`,
            'estagio': `MATRICULA,TITULO DO CARGO
35591,ESTAGIARIO
35472,ESTAGIARIO
35715,ESTAGIARIO
35719,ESTAGIARIO
35438,ESTAGIARIO
35184,ESTAGIARIO
35186,ESTAGIARIO
35275,ESTAGIARIO
35220,ESTAGIARIO
35133,ESTAGIARIO
35153,ESTAGIARIO
34317,ESTAGIARIO
34319,ESTAGIARIO
34305,ESTAGIARIO
34315,ESTAGIARIO
34346,ESTAGIARIO
34306,ESTAGIARIO
34316,ESTAGIARIO
34349,ESTAGIARIO
34353,ESTAGIARIO
34354,ESTAGIARIO
34625,ESTAGIARIO
35618,ESTAGIARIO
35716,ESTAGIARIO
35087,ESTAGIARIO
35406,ESTAGIARIO
34431,ESTAGIARIO`,
            'desligados': `MATRICULA ,DATA DEMISSÃO,COMUNICADO DE DESLIGAMENTO
34706,2025-05-01,OK
31486,2025-05-01,OK
34641,2025-05-01,OK
26139,2025-05-02,OK
34179,2025-05-04,OK
33482,2025-05-04,OK
33492,2025-05-04,
33627,2025-05-07,OK
33404,2025-05-04,OK
33922,2025-05-08,OK
25707,2025-05-09,OK
34935,2025-05-10,OK
33989,2025-05-11,OK
29294,2025-05-11,OK
31394,2025-05-16,OK
25670,2025-05-15,OK
34387,2025-05-15,OK
33711,2025-05-17,OK
34819,2025-05-16,OK
35470,2025-05-18,OK`,
            'afastados': `MATRICULA,DESC. SITUACAO
32572,Licença Maternidade
25961,Licença Maternidade
21151,Auxílio Doença
25857,Auxílio Doença
31326,Licença Maternidade
32930,Licença Maternidade
30515,Licença Maternidade
34526,Licença Maternidade
34357,Licença Maternidade
34539,Licença Maternidade
34330,Auxílio Doença
30264,Licença Maternidade
32345,Licença Maternidade
30200,Licença Maternidade
34867,Auxílio Doença
34986,Auxílio Doença
34731,Auxílio Doença
34901,Auxílio Doença
33106,Licença Maternidade
25233,Auxílio Doença`,
            'exterior': `Cadastro,Valor
29306,28
31227,554.4
32967,660
34884,554.4`,
            'base_dias_uteis': `SINDICADO,DIAS UTEIS
SITEPD PR - SIND DOS TRAB EM EMPR PRIVADAS DE PROC DE DADOS DE CURITIBA E REGIAO METROPOLITANA,22
SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL,21
SINDPD SP - SIND.TRAB.EM PROC DADOS E EMPR.EMPRESAS PROC DADOS ESTADO DE SP.,22
SINDPD RJ - SINDICATO PROFISSIONAIS DE PROC DADOS DO RIO DE JANEIRO,21`
        };
        
        // Mapeamento dos valores de VR por Sindicato conforme a regra de negócio.
        const sindicato_valor = {
            'SITEPD PR - SIND DOS TRAB EM EMPR PRIVADAS DE PROC DE DADOS DE CURITIBA E REGIAO METROPOLITANA': 35.00,
            'SINDPD RJ - SINDICATO PROFISSIONAIS DE PROC DADOS DO RIO DE JANEIRO': 35.00,
            'SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL': 35.00,
            'SINDPD SP - SIND.TRAB.EM PROC DADOS E EMPR.EMPRESAS PROC DADOS ESTADO DE SP.': 37.50
        };

        const stepProgressFill = document.getElementById('step-progress-fill');
        const overallProgressFill = document.getElementById('overall-progress-fill');
        const currentStepName = document.getElementById('current-step-name');
        const stepProgressText = document.getElementById('step-progress-text');
        const overallProgressText = document.getElementById('overall-progress-text');
        const logArea = document.getElementById('log-area');
        const previewSection = document.getElementById('preview-section');
        const previewTitle = document.getElementById('preview-title');
        const previewContent = document.getElementById('preview-content');
        const stepButtonsContainer = document.getElementById('step-buttons');

        // Definição das etapas do processo, agindo como "agentes" virtuais.
        const processSteps = [
            { id: 0, name: "Consolidação de Dados", buttonText: "Iniciar Processo" },
            { id: 1, name: "Tratamento de Exclusões", buttonText: "Tratar Exclusões" },
            { id: 2, name: "Cálculo do Benefício", buttonText: "Calcular Benefício" },
            { id: 3, name: "Geração do Relatório Final", buttonText: "Gerar Relatório Final" }
        ];

        let processedData = {};
        let currentStepIndex = 0;

        /**
         * Adiciona uma mensagem ao log na interface.
         * @param {string} message A mensagem a ser exibida.
         * @param {string} type O tipo de mensagem ('info', 'progress', 'error').
         */
        function logMessage(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = message;
            if (type === 'progress') {
                p.classList.add('font-semibold', 'text-gray-700');
            } else if (type === 'error') {
                p.classList.add('text-red-600', 'font-bold');
            }
            logArea.appendChild(p);
            logArea.scrollTop = logArea.scrollHeight;
        }

        /**
         * Atualiza o progresso das barras na UI.
         * @param {HTMLElement} progressElement O elemento da barra de progresso.
         * @param {HTMLElement} textElement O elemento de texto do progresso.
         * @param {number} progressValue O valor do progresso (0-100).
         */
        function updateProgress(progressElement, textElement, progressValue) {
            progressElement.style.width = `${progressValue}%`;
            textElement.textContent = `${Math.round(progressValue)}%`;
        }

        /**
         * Simula o progresso de uma etapa.
         * @param {number} duration A duração da simulação em milissegundos.
         * @param {number} overallProgressPerStep O progresso total alcançado no início da etapa.
         * @param {number} totalSteps O número total de etapas.
         * @returns {Promise<void>} Uma promessa que resolve quando a simulação termina.
         */
        function simulateProgress(duration, overallProgressPerStep, totalSteps) {
            return new Promise((resolve) => {
                let progress = 0;
                const interval = 50;
                const totalUpdates = duration / interval;
                const increment = 100 / totalUpdates;

                const stepInterval = setInterval(() => {
                    if (progress >= 100) {
                        clearInterval(stepInterval);
                        resolve();
                    } else {
                        progress += increment;
                        const overallProgress = overallProgressPerStep + (progress / totalSteps);

                        updateProgress(stepProgressFill, stepProgressText, Math.min(100, progress));
                        updateProgress(overallProgressFill, overallProgressText, Math.min(100, overallProgress));
                    }
                }, interval);
            });
        }

        /**
         * Renderiza um preview dos dados na tela.
         * @param {string} title O título do preview.
         * @param {Array<Object>} content Os dados a serem exibidos em formato de tabela.
         * @param {Array<string>} logMessages Mensagens adicionais para o log do preview.
         */
        function renderPreview(title, content, logMessages) {
            previewTitle.textContent = title;
            previewContent.innerHTML = '';
            previewSection.style.display = 'block';

            logMessages.forEach(msg => {
                const p = document.createElement('p');
                p.textContent = msg;
                p.classList.add('text-gray-700', 'text-sm', 'mb-2');
                previewContent.appendChild(p);
            });

            if (Array.isArray(content) && content.length > 0) {
                const table = document.createElement('table');
                table.classList.add('preview-table');

                const headers = Object.keys(content[0]);
                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });

                const tbody = table.createTBody();
                content.forEach(item => {
                    const row = tbody.insertRow();
                    Object.values(item).forEach(text => {
                        const cell = row.insertCell();
                        cell.textContent = text;
                    });
                });
                previewContent.appendChild(table);
            } else {
                previewContent.innerHTML += '<p class="text-gray-500 mt-4">Nenhum dado para pré-visualização.</p>';
            }
        }

        /**
         * Converte um array de objetos para uma string CSV.
         * @param {Array<Object>} data O array de objetos.
         * @returns {string} A string formatada em CSV.
         */
        function convertToCSV(data) {
            if (!Array.isArray(data) || data.length === 0) {
                return '';
            }
            const headers = Object.keys(data[0]);
            const headerRow = headers.join(',');
            const dataRows = data.map(row => headers.map(header => {
                const value = row[header];
                return (typeof value === 'string' && value.includes(',')) ? `"${value}"` : value;
            }).join(','));
            return [headerRow, ...dataRows].join('\n');
        }

        /**
         * Baixa um arquivo no formato CSV.
         * @param {string} content O conteúdo do arquivo.
         * @param {string} filename O nome do arquivo.
         */
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Baixa um arquivo no formato PDF.
         * @param {Array<Object>} data Os dados a serem incluídos no PDF.
         * @param {string} filename O nome do arquivo.
         */
        function downloadPDF(data, filename) {
            const doc = new jsPDF();
            const title = `Relatório de VR - ${filename.replace('.pdf', '')}`;

            doc.setFontSize(22);
            doc.text(title, 105, 20, null, null, "center");

            if (Array.isArray(data) && data.length > 0) {
                const headers = Object.keys(data[0]);
                const body = data.map(item => Object.values(item));
                doc.autoTable({
                    head: [headers],
                    body: body,
                    startY: 30,
                    theme: 'striped',
                    headStyles: { fillColor: [79, 70, 229] }
                });
            } else {
                doc.text("Nenhum dado para gerar o relatório.", 10, 40);
            }
            doc.save(filename);
        }

        /**
         * Converte uma string CSV em um array de objetos, tratando nomes de colunas com espaços.
         * @param {string} csv A string CSV.
         * @returns {Array<Object>} O array de objetos.
         */
        function parseCSV(csv) {
            const lines = csv.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) return []; // Linha de cabeçalho e dados podem estar ausentes

            const headers = lines[0].split(',').map(h => h.trim().replace(/\s+/, ' '));
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/\s+/, ' '));
                if (values.length !== headers.length) {
                    // Loga uma mensagem de aviso para linhas com formato incorreto
                    console.warn(`Aviso: Linha com formato inconsistente, ignorada. Linha: ${line}`);
                    return null;
                }
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index];
                });
                return obj;
            }).filter(item => item !== null);
        }

        /**
         * Simula a chamada à API do Gemini para um agente virtual.
         * Para esta demonstração, o agente está implementado como uma função JS.
         * @param {string} prompt O prompt de entrada para o "agente".
         * @param {Object} data Os dados a serem processados.
         * @returns {Promise<any>} A promessa com o resultado do processamento.
         */
        async function runAgent(prompt, data) {
            // Simulação de um agente Gemini para gerar dados formatados.
            // Para este cenário, o agente final de geração de relatório opera sobre o JSON de entrada.
            // Em uma implementação real, faríamos uma chamada `fetch` para a API.
            console.log(`Agente Virtual ativado com o prompt: "${prompt}"`);
            return new Promise(resolve => {
                setTimeout(() => {
                    // Simula a resposta do agente.
                    resolve(data);
                }, 500);
            });
        }

        /**
         * Etapa 1: Consolidação de Dados.
         * Reúne informações de várias bases em uma única base de dados.
         */
        async function consolidateData() {
            logMessage("Agente 1: Iniciando a etapa 'Consolidação de Dados'...");
            
            const ativos = parseCSV(dados_completos.ativos);
            const admissoes = parseCSV(dados_completos.admissoes);
            const ferias = parseCSV(dados_completos.ferias);
            const baseDiasUteis = parseCSV(dados_completos.base_dias_uteis);

            logMessage("Unindo bases de 'Ativos' e 'Admissões'...");
            let baseConsolidada = [...ativos];
            admissoes.forEach(admissao => {
                 // Verifica se a matrícula da admissão já existe na base de ativos
                const matriculaAdmissao = (admissao.MATRICULA || '').trim();
                if (matriculaAdmissao && !baseConsolidada.some(ativo => (ativo.MATRICULA || '').trim() === matriculaAdmissao)) {
                    baseConsolidada.push(admissao);
                }
            });

            logMessage("Enriquecendo a base com dados de Férias e Dias Úteis...");
            const feriasMap = new Map(ferias.map(f => [(f.MATRICULA || '').trim(), parseInt(f['DIAS DE FÉRIAS'])]));
            const diasUteisMap = new Map(baseDiasUteis.map(s => [(s.SINDICADO || '').trim(), parseInt(s['DIAS UTEIS'])]));

            const baseFinal = baseConsolidada.map(colaborador => {
                const matricula = (colaborador.MATRICULA || '').trim();
                const sindicato = (colaborador.Sindicato || '').trim();
                return {
                    ...colaborador,
                    'DIAS DE FÉRIAS': feriasMap.get(matricula) || 0,
                    'DIAS UTEIS': diasUteisMap.get(sindicato) || 22 // Valor padrão se o sindicato não for encontrado
                };
            });

            return {
                data: baseFinal,
                title: "Base Única Consolidada",
                filename: "base_unica_consolidada.csv",
                logs: [
                    `- Carregando e unindo dados dos arquivos de ativos e admissões.`,
                    `- Adicionando a contagem de dias de férias e dias úteis à base consolidada.`,
                    `- A base consolidada resultante tem ${baseFinal.length} colaboradores.`
                ]
            };
        }

        /**
         * Etapa 2: Tratamento de Exclusões.
         * Remove colaboradores que não são elegíveis ao benefício.
         */
        async function treatExclusions(previousData) {
            logMessage("Agente 2: Iniciando a etapa 'Tratamento de Exclusões'...");

            const afastados = parseCSV(dados_completos.afastados);
            const estagio = parseCSV(dados_completos.estagio);
            const aprendizes = parseCSV(dados_completos.aprendizes);
            const exterior = parseCSV(dados_completos.exterior);
            const desligados = parseCSV(dados_completos.desligados);

            logMessage("Identificando colaboradores para exclusão...");

            // Regra 1: Desligamento até o dia 15 com comunicado 'OK'
            const desligadosExcluir = new Set(desligados.filter(d => {
                const dataDemissao = new Date(d['DATA DEMISSÃO']);
                const comunicado = d['COMUNICADO DE DESLIGAMENTO'];
                return dataDemissao <= new Date('2025-05-15') && comunicado && comunicado.trim().toUpperCase() === 'OK';
            }).map(d => (d['MATRICULA '] || '').trim()));
            
            // Reúne todas as matrículas a serem excluídas.
            const matriculasExcluidas = new Set([
                ...afastados.map(a => (a.MATRICULA || '').trim()),
                ...estagio.map(e => (e.MATRICULA || '').trim()),
                ...aprendizes.map(a => (a.MATRICULA || '').trim()),
                ...exterior.map(e => (e.Cadastro || '').trim()),
                ...desligadosExcluir
            ]);

            const baseElegiveis = previousData.filter(colaborador => {
                const matricula = (colaborador.MATRICULA || '').trim();
                const tituloCargo = (colaborador['TITULO DO CARGO'] || '').toUpperCase();
                const isDiretor = tituloCargo.includes('DIRETOR');
                return matricula && !matriculasExcluidas.has(matricula) && !isDiretor;
            });

            const removedCount = previousData.length - baseElegiveis.length;
            const logs = [
                `- Aplicando filtros para remover colaboradores não elegíveis.`,
                `- Foram removidos ${removedCount} colaboradores.`,
                `- A base final de colaboradores elegíveis tem ${baseElegiveis.length} matrículas.`
            ];

            return {
                data: baseElegiveis,
                title: "Base de Colaboradores Elegíveis (Pós-Exclusões)",
                filename: "base_elegiveis.csv",
                logs: logs
            };
        }

        /**
         * Etapa 3: Cálculo do Benefício.
         * Calcula o valor de VR para cada colaborador na base elegível.
         */
        async function calculateBenefit(previousData) {
            logMessage("Agente 3: Iniciando a etapa 'Cálculo do Benefício'...");
            
            const desligados = parseCSV(dados_completos.desligados);
            const desligadosMap = new Map(desligados.map(d => [(d['MATRICULA '] || '').trim(), d]));

            const baseCalculada = previousData.map(colaborador => {
                let diasAjustados = parseInt(colaborador['DIAS UTEIS']);
                let obs = '';
                const sindicato = (colaborador.Sindicato || '').trim();
                const vrDiario = sindicato_valor[sindicato] || 37.50; // Valor padrão para segurança

                // Ajuste para Férias
                if (colaborador['DIAS DE FÉRIAS'] > 0) {
                    diasAjustados -= parseInt(colaborador['DIAS DE FÉRIAS']);
                    obs += `Férias: ${colaborador['DIAS DE FÉRIAS']} dias. `;
                }

                // Ajuste para Desligamento (proporcional)
                const matricula = (colaborador.MATRICULA || '').trim();
                const desligadoInfo = desligadosMap.get(matricula);
                if (desligadoInfo && new Date(desligadoInfo['DATA DEMISSÃO']) > new Date('2025-05-15')) {
                    const dataDemissao = new Date(desligadoInfo['DATA DEMISSÃO']);
                    const diaDoMes = dataDemissao.getDate();
                    diasAjustados = diaDoMes;
                    obs += `Desligamento proporcional até o dia ${diaDoMes}. `;
                }
                
                // Trata a situação de colaborador recém-admitido
                if (colaborador.Admissão && colaborador.Admissão !== 'Trabalhando') {
                     const dataAdmissao = new Date(colaborador.Admissão);
                     // Considera que a folha ponto inicia em 15/04 e termina em 15/05
                     const umDia = 24 * 60 * 60 * 1000; // Milissegundos em um dia
                     
                     let diasUteisContados = 0;
                     for (let d = new Date(dataAdmissao); d <= new Date('2025-05-15'); d = new Date(d.getTime() + umDia)) {
                         const diaDaSemana = d.getDay();
                         if (diaDaSemana !== 0 && diaDaSemana !== 6) { // 0 = Domingo, 6 = Sábado
                             diasUteisContados++;
                         }
                     }
                     diasAjustados = diasUteisContados;
                     obs += `Admissão: Proporcional a partir de ${colaborador.Admissão}. `;
                }

                diasAjustados = Math.max(0, diasAjustados); // Garante que não haja dias negativos

                const total = diasAjustados * vrDiario;
                const custoEmpresa = total * 0.8;
                const descontoProfissional = total * 0.2;
                
                return {
                    ...colaborador,
                    'Dias Ajustados': diasAjustados,
                    'VALOR DIÁRIO VR': vrDiario,
                    'TOTAL': total.toFixed(2),
                    'Custo Empresa': custoEmpresa.toFixed(2),
                    'Desconto Profissional': descontoProfissional.toFixed(2),
                    'OBS GERAL': obs.trim()
                };
            });

            const logs = [
                `- Determinando os dias úteis para cada sindicato com base no arquivo.`,
                `- Aplicando ajuste de dias para colaboradores em férias e proporcionalidade para desligamentos após o dia 15.`,
                `- Calculando o valor total, o custo da empresa (80%) e o desconto do colaborador (20%).`
            ];

            return {
                data: baseCalculada,
                title: "Base de Dados com Cálculo de Benefício",
                filename: "calculo_beneficio.csv",
                logs: logs
            };
        }

        /**
         * Etapa 4: Geração do Relatório Final.
         * Formata os dados calculados para o layout de compra da operadora.
         */
        async function generateFinalReport(previousData) {
            logMessage("Agente 4: Iniciando a etapa 'Geração do Relatório Final'...");
            
            const prompt = `Formate o seguinte conjunto de dados de colaboradores em um layout de planilha de compra de Vale-Refeição para uma operadora, conforme o modelo da aba 'VR Mensal 05.2025'. Inclua Matrícula, Sindicato, Competência ('Maio de 2025'), Dias Ajustados, Valor Diário VR, Total, Custo Empresa, Desconto Profissional e uma coluna de Observações.`;
            
            // Simulação de chamada ao agente Gemini para formatação
            const formattedData = await runAgent(prompt, previousData.map(colaborador => {
                return {
                    'Matrícula': colaborador.MATRICULA,
                    'Sindicato do Colaborador': colaborador.Sindicato,
                    'Competência': 'Maio de 2025',
                    'Dias': colaborador['Dias Ajustados'],
                    'VALOR DIÁRIO VR': colaborador['VALOR DIÁRIO VR'],
                    'TOTAL': colaborador.TOTAL,
                    'Custo empresa': colaborador['Custo Empresa'],
                    'Desconto profissional': colaborador['Desconto Profissional'],
                    'OBS GERAL': colaborador['OBS GERAL']
                };
            }));
            
            const logs = [
                `- O relatório final está sendo formatado com as colunas necessárias para o arquivo de folha de pagamento.`,
                `- Ele inclui Matrícula, Sindicato, Dias Ajustados e os valores de VR calculados.`
            ];
            
            return {
                data: formattedData,
                title: "Relatório Final para a Operadora",
                filename: "relatorio_final.csv",
                logs: logs
            };
        }

        async function runStep(stepId) {
            const step = processSteps[stepId];
            logArea.innerHTML = '';
            previewSection.style.display = 'none';

            updateProgress(stepProgressFill, stepProgressText, 0);
            currentStepName.textContent = step.name;
            logMessage(`Iniciando a etapa: "${step.name}"...`, 'progress');

            const overallProgressPerStep = (step.id / processSteps.length) * 100;
            await simulateProgress(2000, overallProgressPerStep, processSteps.length);

            let result = null;
            try {
                if (step.id === 0) {
                    result = await consolidateData();
                } else if (step.id === 1) {
                    const previousData = processedData[0].data;
                    result = await treatExclusions(previousData);
                } else if (step.id === 2) {
                    const previousData = processedData[1].data;
                    result = await calculateBenefit(previousData);
                } else if (step.id === 3) {
                    const previousData = processedData[2].data;
                    result = await generateFinalReport(previousData);
                }
            } catch (e) {
                logMessage(`Erro na etapa "${step.name}": ${e.message}`, 'error');
                return; // Para a execução em caso de erro
            }

            processedData[stepId] = result;
            renderPreview(result.title, result.data.slice(0, 10), result.logs);
            updateProgress(stepProgressFill, stepProgressText, 100);
            logMessage(`Etapa "${step.name}" concluída.`, 'progress');

            if (currentStepIndex < processSteps.length) {
                currentStepIndex++;
            }
            updateUI();
        }
        
        function updateUI() {
            stepButtonsContainer.innerHTML = '';
            const totalSteps = processSteps.length;

            processSteps.forEach((step, index) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item';

                const stepLabel = document.createElement('span');
                stepLabel.className = 'step-label';
                stepLabel.textContent = `${index + 1}. ${step.name}`;
                stepItem.appendChild(stepLabel);

                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';

                const runBtn = document.createElement('button');
                runBtn.textContent = (index === currentStepIndex) ? 'Rodar Etapa' : 'Visualizar';
                runBtn.className = 'btn btn-run';
                runBtn.disabled = index > currentStepIndex;
                runBtn.onclick = () => {
                    if (index === currentStepIndex) {
                        runStep(index);
                    } else if (index < currentStepIndex) {
                        const data = processedData[index];
                        const previewContent = data.data.slice(0, 10);
                        renderPreview(data.title, previewContent, data.logs);
                    }
                };
                btnGroup.appendChild(runBtn);

                if (index < currentStepIndex) {
                    const downloadCsvBtn = document.createElement('button');
                    downloadCsvBtn.textContent = 'Baixar CSV';
                    downloadCsvBtn.className = 'btn btn-download';
                    downloadCsvBtn.onclick = () => {
                        const { data, filename } = processedData[index];
                        const csvContent = convertToCSV(data);
                        downloadFile(csvContent, filename);
                    };
                    btnGroup.appendChild(downloadCsvBtn);

                    const downloadPdfBtn = document.createElement('button');
                    downloadPdfBtn.textContent = 'Baixar PDF';
                    downloadPdfBtn.className = 'btn btn-download';
                    downloadPdfBtn.onclick = () => {
                        const { data, filename } = processedData[index];
                        downloadPDF(data, filename.replace('.csv', '.pdf'));
                    };
                    btnGroup.appendChild(downloadPdfBtn);
                }

                stepItem.appendChild(btnGroup);
                stepButtonsContainer.appendChild(stepItem);
            });

            const overallProgressValue = (currentStepIndex / totalSteps) * 100;
            updateProgress(overallProgressFill, overallProgressText, overallProgressValue);

            if (currentStepIndex >= totalSteps) {
                currentStepName.textContent = 'Processo Completo';
            } else {
                currentStepName.textContent = processSteps[currentStepIndex].name;
            }
        }
        
        updateUI();
    </script>
</body>
</html>
