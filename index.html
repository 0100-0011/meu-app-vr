<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente de Automação de VR com Gemini</title>
    <!-- Inclui o Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 960px;
        }
        .btn {
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1c64f2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .step-container {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
    </style>
</head>
<body class="p-6">

    <div class="container mx-auto bg-white rounded-xl shadow-lg p-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Agente de Automação de VR com Gemini</h1>
        <p class="text-center text-gray-600 mb-6">
            Bem-vindo ao agente de automação do cálculo de Vale Refeição. A execução do primeiro passo já começou. Siga os botões abaixo para continuar.
        </p>

        <!-- Controles de Automação Passo a Passo -->
        <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-4 mb-8">
            <button id="step-1-btn" class="btn bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg" disabled>
                1. Consolidar Dados
            </button>
            <button id="step-2-btn" class="btn bg-gray-400 text-white font-bold py-3 px-6 rounded-full shadow-lg" disabled>
                2. Tratar Exclusões
            </button>
            <button id="step-3-btn" class="btn bg-gray-400 text-white font-bold py-3 px-6 rounded-full shadow-lg" disabled>
                3. Calcular Benefício
            </button>
            <button id="step-4-btn" class="btn bg-gray-400 text-white font-bold py-3 px-6 rounded-full shadow-lg" disabled>
                4. Gerar Relatório
            </button>
        </div>
        
        <div id="status-container" class="mt-8 space-y-4">
            <!-- As mensagens de status e pré-visualizações serão injetadas aqui dinamicamente -->
        </div>

    </div>

    <script>
        // Definição dos dados CSV como strings JavaScript
        const dadosCsv = {
            'ativos': `MATRICULA,EMPRESA,TITULO DO CARGO,DESC. SITUACAO,Sindicato
34941,1410,TECH RECRUITER II,Trabalhando,SINDPD SP - SIND.TRAB.EM PROC DADOS E EMPR.EMPRESAS PROC DADOS ESTADO DE SP.
24401,1410,COORDENADOR ADMINISTRATIVO,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
32104,1410,ANALISTA CONTABIL-FISCAL II,Férias,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
35254,1410,ANALISTA CONTABIL-FISCAL II,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
31731,1410,ANALISTA CONTABIL-FISCAL III,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
31009,1410,ANALISTA DE CONTROLADORIA I,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
28979,1410,ANALISTA DE CONTROLADORIA II,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
24122,1410,ANALISTA DE CONTROLADORIA III,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
30556,1410,DESENVOLVEDOR II,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
35627,1410,ASSISTENTE DE BPO I,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
34789,1410,ASSISTENTE DE BPO I,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
24505,1410,DESENVOLVEDOR III,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
27071,1410,DESENVOLVEDOR III,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
24475,1410,ANALISTA DE SISTEMAS E NEGOCIOS II,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
26273,1410,ANALISTA DE SISTEMAS E NEGOCIOS II,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL
32050,1410,ANALISTA DE SISTEMAS E NEGOCIOS III,Trabalhando,SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL`,
            'ferias': `MATRICULA,DESC. SITUACAO,DIAS DE FÉRIAS
32104,Férias,10
32761,Férias,10
30567,Férias,10
30502,Férias,15
33998,Férias,20
30867,Férias,10
31237,Férias,15
32278,Férias,20
33808,Férias,5
26910,Férias,30
30206,Férias,30
32216,Férias,30
30570,Férias,30
32589,Férias,30
31740,Férias,30
33235,Férias,30
34042,Férias,30
33420,Férias,5
31190,Férias,5
31208,Férias,5
33715,Férias,5
30280,Férias,5
34444,Férias,5
29058,Férias,15
33628,Férias,20
33795,Férias,15
33633,Férias,20
26463,Férias,10
31333,Férias,20`,
            'afastamentos': `MATRICULA,DESC. SITUACAO,na compra?,
32572,Licença Maternidade,,
25961,Licença Maternidade,,
21151,Auxílio Doença,,
25857,Auxílio Doença,,
31326,Licença Maternidade,,
32930,Licença Maternidade,,
30515,Licença Maternidade,30515,retorno de férias + licença em 11/06
34526,Licença Maternidade,34526,retorno de férias + licença em 12/06
34357,Licença Maternidade,,
34539,Licença Maternidade,34539,retorno da licença em 04/06
34330,Auxílio Doença,,
30264,Licença Maternidade,,
32345,Licença Maternidade,32345,retorno de férias + licença em 26/05
30200,Licença Maternidade,,
34867,Auxílio Doença,,
34986,Auxílio Doença,,
34731,Auxílio Doença,,
34901,Auxílio Doença,,
33106,Licença Maternidade,33106,retorno da licença em 05/06
25233,Auxílio Doença,,`,
            'desligados': `MATRICULA ,DATA DEMISSÃO,COMUNICADO DE DESLIGAMENTO
34706,2025-05-01,OK
31486,2025-05-01,OK
34641,2025-05-01,OK
26139,2025-05-02,OK
34179,2025-05-04,OK
33482,2025-05-04,OK
33492,2025-05-04,
33627,2025-05-07,OK
33404,2025-05-04,OK
33922,2025-05-08,OK
25707,2025-05-09,OK
34935,2025-05-10,OK
33989,2025-05-11,OK
29294,2025-05-11,OK
31394,2025-05-16,OK
25670,2025-05-15,OK
34387,2025-05-15,OK
33711,2025-05-17,OK
34819,2025-05-16,OK
35471,2025-05-16,
32967,2025-05-18,`,
            'aprendizes': `MATRICULA,TITULO DO CARGO
34383,APRENDIZ
34404,APRENDIZ
35086,APRENDIZ
34396,APRENDIZ
34403,APRENDIZ
35640,APRENDIZ
34951,APRENDIZ TECH
34950,APRENDIZ TI
35088,APRENDIZ
35635,APRENDIZ
35081,APRENDIZ
35641,APRENDIZ
35637,APRENDIZ
35639,APRENDIZ
35642,APRENDIZ
35636,APRENDIZ
35607,APRENDIZ AUX  ADMINISTRATIVO
35366,APRENDIZ
35643,APRENDIZ
34392,APRENDIZ
35085,APRENDIZ
34398,APRENDIZ
35089,APRENDIZ
35644,APRENDIZ
34394,APRENDIZ
34953,APRENDIZ TECH
35058,APRENDIZ
35638,APRENDIZ
34952,APRENDIZ
35571,APRENDIZ
35609,APRENDIZ AUX  ADMINISTRATIVO
35610,APRENDIZ AUX  ADMINISTRATIVO
35608,APRENDIZ AUX  ADMINISTRATIVO`,
            'estagio': `MATRICULA,TITULO DO CARGO,na compra?
35591,ESTAGIARIO,#REF!
35472,ESTAGIARIO,#REF!
35715,ESTAGIARIO,#REF!
35719,ESTAGIARIO,#REF!
35438,ESTAGIARIO,#REF!
35184,ESTAGIARIO,#REF!
35186,ESTAGIARIO,#REF!
35275,ESTAGIARIO,#REF!
35220,ESTAGIARIO,#REF!
35133,ESTAGIARIO,#REF!
35153,ESTAGIARIO,#REF!
34317,ESTAGIARIO,#REF!
34319,ESTAGIARIO,#REF!
34305,ESTAGIARIO,#REF!
34315,ESTAGIARIO,#REF!
34346,ESTAGIARIO,#REF!
34306,ESTAGIARIO,#REF!
34316,ESTAGIARIO,#REF!
34349,ESTAGIARIO,#REF!
34353,ESTAGIARIO,#REF!
34354,ESTAGIARIO,#REF!
34625,ESTAGIARIO,#REF!
35618,ESTAGIARIO,#REF!
35716,ESTAGIARIO,#REF!
35087,ESTAGIARIO,#REF!
35406,ESTAGIARIO,#REF!
34431,ESTAGIARIO,#REF!
35616,ESTAGIARIO,#REF!
35697,ESTAGIARIO,#REF!
35698,ESTAGIARIO,#REF!
35592,ESTAGIARIO,#REF!
35604,ESTAGIARIO,#REF!`,
            'exterior': `Cadastro,Valor,
29306,28,desligado
31227,554.4,RETORNOU DO EXTERIOR - devido o pgto
32967,660,removido
34884,554.4,`,
            'base_dias_uteis': `SINDICADO,DIAS UTEIS 
SITEPD PR - SIND DOS TRAB EM EMPR PRIVADAS DE PROC DE DADOS DE CURITIBA E REGIAO METROPOLITANA,22
SINDPPD RS - SINDICATO DOS TRAB. EM PROC. DE DADOS RIO GRANDE DO SUL,21
SINDPD SP - SIND.TRAB.EM PROC DADOS E EMPR.EMPRESAS PROC DADOS ESTADO DE SP.,22
SINDPD RJ - SINDICATO PROFISSIONAIS DE PROC DADOS DO RIO DE JANEIRO,21`
        };

        const VR_DIARIO = 37.5;
        const MES_COMPETENCIA = '05';

        // Variáveis de estado global para compartilhar dados entre os passos
        let dfConsolidado = [];
        let dfElegiveis = [];

        /**
         * Converte uma string CSV em um array de objetos.
         * @param {string} csvString A string com dados no formato CSV.
         * @returns {Array<Object>} O array de objetos representando o CSV.
         */
        function parseCSV(csvString) {
            const lines = csvString.trim().split('\n');
            if (lines.length <= 1) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) continue;
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = values[j];
                }
                result.push(obj);
            }
            return result;
        }

        /**
         * Exibe uma mensagem de status com um spinner.
         * @param {string} message A mensagem a ser exibida.
         * @param {string} id O ID do passo para identificação.
         */
        function showStatus(message, id) {
            const statusContainer = document.getElementById('status-container');
            const stepDiv = document.createElement('div');
            stepDiv.id = `step-${id}`;
            stepDiv.className = 'flex items-center space-x-2 p-4 rounded-lg bg-gray-100 text-gray-700';
            stepDiv.innerHTML = `<div class="spinner"></div><span>${message}</span>`;
            statusContainer.appendChild(stepDiv);
        }

        /**
         * Exibe um preview em uma tabela.
         * @param {string} title Título da tabela.
         * @param {Array<Object>} data Os dados a serem exibidos.
         * @param {Array<string>} headers Os cabeçalhos da tabela.
         * @param {string} containerId O ID do contêiner onde a tabela será inserida.
         */
        function showTablePreview(title, data, headers, containerId) {
            const container = document.getElementById(containerId);
            const tableDiv = document.createElement('div');
            tableDiv.className = 'step-container mt-4';
            tableDiv.innerHTML = `
                <h2 class="text-lg font-semibold text-gray-800 mb-4">${title}</h2>
                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                ${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${data.map(row => `
                                <tr>
                                    ${Object.values(row).map(val => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${val}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.appendChild(tableDiv);
        }

        /**
         * Exibe um preview em uma lista.
         * @param {string} title Título da lista.
         * @param {Array<Object>} data Os dados a serem exibidos.
         * @param {string} containerId O ID do contêiner onde a lista será inserida.
         */
        function showListPreview(title, data, containerId) {
            const container = document.getElementById(containerId);
            const listDiv = document.createElement('div');
            listDiv.className = 'step-container mt-4';
            listDiv.innerHTML = `
                <h2 class="text-lg font-semibold text-gray-800 mb-4">${title}</h2>
                <ul class="list-disc list-inside bg-gray-100 p-4 rounded-lg space-y-2">
                    ${data.map(item => `<li class="text-sm text-gray-700">Matrícula: ${item.Matrícula} - Motivo: ${item.Motivo}</li>`).join('')}
                </ul>
            `;
            container.appendChild(listDiv);
        }
        
        /**
         * Função que chama a API do Gemini para gerar o relatório final.
         * @param {string} prompt O texto a ser enviado para o modelo.
         * @returns {Promise<string>} O texto gerado pelo modelo.
         */
        async function generateReportWithGemini(prompt) {
            const geminiReportDiv = document.getElementById('gemini-report');
            const loadingHtml = `<div class="loading-text mt-4"><div class="spinner mr-2"></div><span class="text-sm text-gray-500">Gerando relatório...</span></div>`;
            geminiReportDiv.innerHTML = `<p class="text-gray-600">Aguardando a análise do Gemini...</p>${loadingHtml}`;

            let retryCount = 0;
            const maxRetries = 5;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            while (retryCount < maxRetries) {
                try {
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        console.warn(`API rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        retryCount++;
                        continue;
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        console.error("Estrutura de resposta inesperada da API Gemini:", result);
                        return "Não foi possível gerar o relatório. Tente novamente.";
                    }
                } catch (error) {
                    console.error("Erro ao chamar a API Gemini:", error);
                    return "Ocorreu um erro ao gerar o relatório. Tente novamente.";
                }
            }
            return "Falha ao gerar o relatório após várias tentativas devido ao limite de taxa da API.";
        }

        // ======================= FUNÇÕES DE CADA PASSO =======================

        async function step1_consolidate_data() {
            const btn = document.getElementById('step-1-btn');
            btn.textContent = 'Processando...';
            
            showStatus('Passo 1: Consolidando dados de colaboradores e férias...', 1);
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            let dfAtivos = parseCSV(dadosCsv.ativos);
            const dfFerias = parseCSV(dadosCsv.ferias);
            
            const feriasMap = new Map(dfFerias.map(item => [item['MATRICULA'], parseInt(item['DIAS DE FÉRIAS'])]));
            dfConsolidado = dfAtivos.map(colaborador => {
                colaborador['DIAS DE FÉRIAS'] = feriasMap.get(colaborador['MATRICULA']) || 0;
                colaborador['excluido'] = false;
                colaborador['motivo_exclusao'] = '';
                return colaborador;
            });
            
            const previewData = dfConsolidado.map(c => ({
                'Matrícula': c['MATRICULA'],
                'Cargo': c['TITULO DO CARGO'],
                'Sindicato': c['Sindicato'],
                'Dias de Férias': c['DIAS DE FÉRIAS']
            }));
            const previewHeaders = ['Matrícula', 'Cargo', 'Sindicato', 'Dias de Férias'];
            
            showTablePreview('Pré-visualização dos Dados Consolidados', previewData, previewHeaders, 'status-container');

            btn.textContent = '✅ Concluído';
            btn.classList.remove('bg-blue-600');
            btn.classList.add('bg-green-600');
            
            const nextBtn = document.getElementById('step-2-btn');
            nextBtn.disabled = false;
            nextBtn.classList.remove('bg-gray-400');
            nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        async function step2_handle_exclusions() {
            const btn = document.getElementById('step-2-btn');
            btn.textContent = 'Processando...';
            btn.disabled = true;
            
            showStatus('Passo 2: Tratando exclusões (aprendizes, estagiários, desligados, afastados)...', '2-status');
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Carrega as listas de exclusão e remove espaços em branco extras dos IDs
            const dfAprendizes = parseCSV(dadosCsv.aprendizes);
            const dfEstagio = parseCSV(dadosCsv.estagio);
            const dfAfastados = parseCSV(dadosCsv.afastamentos);
            const dfDesligados = parseCSV(dadosCsv.desligados);
            const dfExterior = parseCSV(dadosCsv.exterior);

            const excluidosAprendizes = new Set(dfAprendizes.map(a => a['MATRICULA'].trim()));
            const excluidosEstagio = new Set(dfEstagio.map(e => e['MATRICULA'].trim()));
            const excluidosAfastados = new Set(dfAfastados.map(a => a['MATRICULA'].trim()));
            const excluidosDesligados = new Set(dfDesligados.map(d => d['MATRICULA '].trim())); // O nome da coluna tem um espaço
            const excluidosExterior = new Set(dfExterior.map(e => e['Cadastro'].trim()));

            let totalExcluidos = 0;
            const listaExcluidos = [];
            
            dfConsolidado.forEach(colaborador => {
                const matricula = colaborador['MATRICULA'].trim();
                let motivo = '';

                if (excluidosAprendizes.has(matricula)) {
                    motivo = 'Aprendiz';
                } else if (excluidosEstagio.has(matricula)) {
                    motivo = 'Estagiário';
                } else if (excluidosAfastados.has(matricula)) {
                    motivo = 'Afastado';
                } else if (excluidosDesligados.has(matricula)) {
                    motivo = 'Desligado';
                } else if (excluidosExterior.has(matricula)) {
                    motivo = 'No Exterior';
                }

                if (motivo) {
                    colaborador.excluido = true;
                    colaborador.motivo_exclusao = motivo;
                    totalExcluidos++;
                    listaExcluidos.push({ Matrícula: matricula, Motivo: motivo });
                }
            });
            
            // Filtra os elegíveis para a próxima etapa
            dfElegiveis = dfConsolidado.filter(c => !c.excluido);

            showListPreview(`Pré-visualização de ${totalExcluidos} Colaboradores Excluídos`, listaExcluidos, 'status-container');
            showTablePreview(
                `Pré-visualização de ${dfElegiveis.length} Colaboradores Elegíveis`,
                dfElegiveis.map(c => ({ 'Matrícula': c['MATRICULA'], 'Cargo': c['TITULO DO CARGO'] })),
                ['Matrícula', 'Cargo'],
                'status-container'
            );

            btn.textContent = '✅ Concluído';
            btn.classList.remove('bg-blue-600');
            btn.classList.add('bg-green-600');
            
            const nextBtn = document.getElementById('step-3-btn');
            nextBtn.disabled = false;
            nextBtn.classList.remove('bg-gray-400');
            nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        async function step3_calculate_benefits() {
            const btn = document.getElementById('step-3-btn');
            btn.textContent = 'Processando...';
            btn.disabled = true;

            showStatus('Passo 3: Calculando o valor do benefício para os elegíveis...', '3-status');
            await new Promise(resolve => setTimeout(resolve, 1000));

            const dfDiasUteis = parseCSV(dadosCsv.base_dias_uteis);
            const diasUteisMap = new Map(dfDiasUteis.map(item => [item['SINDICADO'].trim(), parseInt(item['DIAS UTEIS '])]));

            let totalElegiveis = 0;
            let totalVr = 0;
            
            const relatorioCalculo = dfElegiveis.map(colaborador => {
                totalElegiveis++;
                const diasUteisBase = diasUteisMap.get(colaborador['Sindicato']) || 22;
                const diasVr = Math.max(0, diasUteisBase - colaborador['DIAS DE FÉRIAS']);
                const valorTotalVr = diasVr * VR_DIARIO;
                totalVr += valorTotalVr;

                return {
                    'Matrícula': colaborador['MATRICULA'],
                    'Sindicato': colaborador['Sindicato'],
                    'Dias Úteis': diasUteisBase,
                    'Dias de Férias': colaborador['DIAS DE FÉRIAS'],
                    'Dias VR': diasVr,
                    'Valor Total VR': `R$ ${valorTotalVr.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.')}`
                };
            });

            const previewHeaders = ['Matrícula', 'Sindicato', 'Dias Úteis', 'Dias de Férias', 'Dias VR', 'Valor Total VR'];
            showTablePreview('Pré-visualização do Cálculo de VR', relatorioCalculo, previewHeaders, 'status-container');

            btn.textContent = '✅ Concluído';
            btn.classList.remove('bg-blue-600');
            btn.classList.add('bg-green-600');
            
            const nextBtn = document.getElementById('step-4-btn');
            nextBtn.disabled = false;
            nextBtn.classList.remove('bg-gray-400');
            nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        async function step4_generate_report() {
            const btn = document.getElementById('step-4-btn');
            btn.textContent = 'Processando...';
            btn.disabled = true;

            const totalElegiveis = dfElegiveis.length;
            const totalVr = dfElegiveis.reduce((acc, c) => {
                const diasUteisBase = (parseCSV(dadosCsv.base_dias_uteis).find(d => d['SINDICADO'].trim() === c['Sindicato']) || { 'DIAS UTEIS ': 22 })['DIAS UTEIS '];
                const diasVr = Math.max(0, diasUteisBase - c['DIAS DE FÉRIAS']);
                return acc + (diasVr * VR_DIARIO);
            }, 0);
            const totalExcluidos = dfConsolidado.length - totalElegiveis;

            const prompt = `
            Com base nos seguintes dados processados, gere um resumo profissional e conciso para um relatório de Vale Refeição. Inclua o valor total do VR, o número de colaboradores elegíveis, e qualquer insight relevante sobre os dados.
            
            Dados de entrada:
            - Valor total a ser pago em VR: R$ ${totalVr.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.')}
            - Total de colaboradores elegíveis: ${totalElegiveis}
            - Colaboradores excluídos: ${totalExcluidos}
            
            O relatório deve ser formal, amigável e focado nos resultados principais. Não precisa ser muito longo, apenas um resumo direto e relevante para o gestor de RH.
            `;
            
            const resultContainer = document.createElement('div');
            resultContainer.id = 'result-container';
            resultContainer.className = 'mt-8';
            resultContainer.innerHTML = `
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Relatório Final de Vale Refeição</h2>
                <div id="gemini-report" class="bg-gray-100 p-6 rounded-lg mb-6">
                    <p class="text-gray-600">Aguardando a análise do Gemini...</p>
                    <div class="loading-text mt-4">
                        <div class="spinner mr-2"></div>
                        <span class="text-sm text-gray-500">Gerando relatório...</span>
                    </div>
                </div>
            `;
            document.getElementById('status-container').appendChild(resultContainer);
            
            const geminiReport = await generateReportWithGemini(prompt);
            document.getElementById('gemini-report').innerHTML = `<p class="text-gray-800">${geminiReport}</p>`;
            
            const relatorioFinal = dfElegiveis.map(colaborador => {
                const diasUteisBase = (parseCSV(dadosCsv.base_dias_uteis).find(d => d['SINDICADO'].trim() === colaborador['Sindicato']) || { 'DIAS UTEIS ': 22 })['DIAS UTEIS '];
                const diasVr = Math.max(0, diasUteisBase - colaborador['DIAS DE FÉRIAS']);
                const valorTotalVr = diasVr * VR_DIARIO;

                return {
                    'Matrícula': colaborador['MATRICULA'],
                    'Cargo': colaborador['TITULO DO CARGO'],
                    'Sindicato': colaborador['Sindicato'],
                    'Dias Úteis': diasUteisBase,
                    'Dias de Férias': colaborador['DIAS DE FÉRIAS'],
                    'Dias VR': diasVr,
                    'Valor Total VR': `R$ ${valorTotalVr.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.')}`
                };
            });

            const previewHeaders = ['Matrícula', 'Cargo', 'Sindicato', 'Dias Úteis', 'Dias de Férias', 'Dias VR', 'Valor Total VR'];
            showTablePreview('Tabela Detalhada do Cálculo', relatorioFinal, previewHeaders, 'status-container');


            btn.textContent = '✅ Concluído';
            btn.classList.remove('bg-blue-600');
            btn.classList.add('bg-green-600');
        }


        // ======================= EVENT LISTENERS =======================
        window.onload = function() {
            // Inicia o primeiro passo automaticamente
            step1_consolidate_data();

            // Adiciona listeners para os botões dos passos subsequentes
            document.getElementById('step-2-btn').addEventListener('click', step2_handle_exclusions);
            document.getElementById('step-3-btn').addEventListener('click', step3_calculate_benefits);
            document.getElementById('step-4-btn').addEventListener('click', step4_generate_report);
        };
    </script>

</body>
</html>
